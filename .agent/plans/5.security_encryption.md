# Plan: Settings Security & Browser Autofill Fix

## Issues
1. **API keys stored in plaintext** in `user_settings` table - need encryption at rest
2. **Browser autofill** filling Base URL fields with saved email/password credentials

## Approach

### 1. Application-Level Encryption (Fernet)

Use Python's `cryptography.fernet.Fernet` for symmetric encryption of API keys before storing in Supabase. This library is already available as a transitive dependency of `python-jose[cryptography]` (in requirements.txt).

**How it works:**
- Add `SETTINGS_ENCRYPTION_KEY` to backend `.env` (a Fernet key generated once)
- Encrypt API key values before INSERT/UPDATE
- Decrypt after SELECT
- Database columns remain TEXT but hold encrypted (base64) ciphertext
- If no encryption key is configured, fall back to plaintext (for dev simplicity)

**Why not Supabase Vault?** Vault is designed for application-level secrets (shared), not per-user credentials. It lacks RLS integration and would require a different data model.

**Why not pgcrypto?** Requires passing the encryption key in every SQL query (over the wire to the DB). Application-level encryption keeps the key entirely server-side.

### 2. Browser Autofill Fix

The browser's password manager is matching:
- Base URL → username field (shows `test@test.com`)
- API Key (`type="password"`) → password field

**Fix:**
- Add `autoComplete="off"` to the form container
- Change API Key fields from `type="password"` to `type="text"` with a show/hide toggle button
- Add `autoComplete="off"` to all inputs
- Use `name` attributes that don't trigger heuristic autofill (avoid "url", "email", "password")

---

## Files to Modify

| File | Change |
|------|--------|
| `backend/app/routers/settings.py` | Add encrypt/decrypt helpers, encrypt before store, decrypt before mask |
| `backend/app/services/llm_service.py` | Decrypt API key after reading from DB |
| `backend/app/services/embedding_service.py` | Decrypt API key after reading from DB |
| `backend/app/config.py` | Add `settings_encryption_key` field |
| `frontend/src/components/SettingsDialog.tsx` | Fix autocomplete, add show/hide toggle for API keys |

## Files NOT Modified
- No new migration needed (columns stay TEXT, data is just encrypted text)
- No new dependencies needed (`cryptography` already available)

---

## Implementation Details

### Backend: `config.py`
Add one field:
```python
settings_encryption_key: str = ""
```

### Backend: `settings.py` - Encryption helpers
```python
from cryptography.fernet import Fernet, InvalidToken

def get_fernet() -> Fernet | None:
    key = get_settings().settings_encryption_key
    if not key:
        return None
    return Fernet(key.encode())

def encrypt_value(value: str | None) -> str | None:
    if not value:
        return None
    f = get_fernet()
    if not f:
        return value  # No encryption key configured, store plaintext
    return f.encrypt(value.encode()).decode()

def decrypt_value(value: str | None) -> str | None:
    if not value:
        return None
    f = get_fernet()
    if not f:
        return value  # No encryption key, assume plaintext
    try:
        return f.decrypt(value.encode()).decode()
    except (InvalidToken, Exception):
        return value  # If decryption fails, return as-is (legacy plaintext)
```

- In `update_settings`: call `encrypt_value()` on API key values before upserting
- In `get_settings`: call `decrypt_value()` on API key values before masking

### Backend: `llm_service.py` and `embedding_service.py`
Add same `decrypt_value` import and apply it when reading `llm_api_key` / `embedding_api_key` from the DB query result.

### Frontend: `SettingsDialog.tsx`
1. Wrap form content in `<form autoComplete="off" onSubmit={e => e.preventDefault()}>`
2. Change API Key inputs from `type="password"` to `type="text"` by default, with a toggle eye icon
3. Add `autoComplete="off"` to every `<Input>`
4. Use neutral `name` attributes (e.g., `name="llm-key-field"` not `name="password"`)

---

## Verification

1. Generate a key: `python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"`
2. Add `SETTINGS_ENCRYPTION_KEY=<generated_key>` to `backend/.env`
3. Restart backend
4. Open settings dialog, enter an API key, save
5. Query `user_settings` table directly in Supabase → API key column should show encrypted ciphertext (starts with `gAAAAA...`)
6. Re-open settings dialog → API key shows masked (`***xxxx`) correctly (decrypted then masked)
7. Chat still works with the configured key (decrypted correctly by llm_service)
8. Base URL fields no longer show browser autofill suggestions
9. API Key fields show text with eye toggle, no browser password prompt

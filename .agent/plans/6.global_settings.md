# Plan: Global Admin-Managed Settings

**Complexity:** ⚠️ Medium

## Summary

Convert per-user settings to global admin-managed settings. Create a `user_profiles` table with `is_admin` boolean, auto-created on signup. Only admins can access the settings UI and modify LLM/embedding config. Remove ALL env var fallbacks for LLM/embedding — config comes exclusively from the `global_settings` table.

---

## Task 1: Database Migration

**File:** `supabase/migrations/20260123000005_global_settings.sql`

Create:
- `user_profiles` table (`user_id`, `is_admin BOOLEAN DEFAULT false`)
- Trigger on `auth.users` INSERT to auto-create profile
- Back-fill existing users with `is_admin = false`
- Set `test@test.com` as admin
- `global_settings` table (single row: `llm_model`, `llm_base_url`, `llm_api_key`, `embedding_model`, `embedding_base_url`, `embedding_api_key`, `embedding_dimensions`)
- RLS: authenticated users can SELECT global_settings; write enforcement is application-layer (backend uses service_role_key)
- Seed `global_settings` from existing `user_settings` data if any
- Drop `user_settings` table

---

## Task 2: Backend — Config Cleanup

**File:** `backend/app/config.py`

Remove these fields entirely:
- `openai_api_key`
- `llm_base_url`, `llm_api_key`, `llm_model`
- `embedding_base_url`, `embedding_api_key`, `embedding_model`, `embedding_dimensions`

Keep only:
- Supabase (`supabase_url`, `supabase_anon_key`, `supabase_service_role_key`)
- LangSmith (`langsmith_api_key`, `langsmith_project`)
- Encryption (`settings_encryption_key`)
- CORS (`cors_origins`)

---

## Task 3: Backend — User Dependencies

**File:** `backend/app/dependencies.py`

- Add `is_admin: bool = False` to the `User` model
- In `get_current_user`: query `user_profiles` table to get `is_admin` flag
- Add new `get_admin_user` dependency that wraps `get_current_user` and raises 403 if not admin

---

## Task 4: Backend — Auth Endpoint

**File:** `backend/app/routers/auth.py`

- Return `is_admin` in the `/auth/me` response (already available on `current_user`)

---

## Task 5: Backend — Settings Router Rewrite

**File:** `backend/app/routers/settings.py`

- `GET /settings` — any authenticated user can read global settings (masked API keys)
- `PUT /settings` — admin only (use `get_admin_user` dependency), returns 403 for non-admins
- `has_chunks` check becomes global: any chunks in the system blocks embedding changes
- Read/write the single `global_settings` row (no user_id scoping)
- Keep encryption/masking logic

---

## Task 6: Backend — LLM Service

**File:** `backend/app/services/llm_service.py`

- Remove module-level `default_async_client` (no env var credentials at import time)
- Replace `get_user_llm_settings(user_id)` with `get_global_llm_settings()`
- `get_global_llm_settings()` reads from `global_settings` table; raises error if unconfigured
- Create client lazily on each call based on global settings
- Remove all references to `settings.openai_api_key`, `settings.llm_api_key`, `settings.llm_base_url`

---

## Task 7: Backend — Embedding Service

**File:** `backend/app/services/embedding_service.py`

- Remove module-level `default_embedding_client`
- Replace `get_user_embedding_settings(user_id)` with `get_global_embedding_settings()`
- `get_global_embedding_settings()` reads from `global_settings` table; raises error if unconfigured
- Create client lazily based on global settings
- Remove all references to `settings.openai_api_key`, `settings.embedding_api_key`, `settings.embedding_base_url`

---

## Task 8: Frontend — Auth Hook

**File:** `frontend/src/hooks/useAuth.ts`

- Add `isAdmin` state
- After session is established, call `GET /auth/me` to fetch `is_admin`
- Expose `isAdmin` from the hook

---

## Task 9: Frontend — UserMenu

**File:** `frontend/src/components/UserMenu.tsx`

- Add `isAdmin` prop
- Only render the Settings button (which navigates to `/settings`) when `isAdmin === true`

---

## Task 10: Frontend — Pages

**Files:** `frontend/src/pages/ChatPage.tsx`, `frontend/src/pages/DocumentsPage.tsx`, `frontend/src/pages/SettingsPage.tsx`

- Destructure `isAdmin` from `useAuth()`
- Pass `isAdmin` prop to `UserMenu`

---

## Task 11: Frontend — Settings Page

**File:** `frontend/src/pages/SettingsPage.tsx`

- Update embedding lock message to reflect global scope ("document chunks exist in the system")
- Update types from `UserSettings` to `GlobalSettings` if applicable
- Add route guard: if non-admin navigates directly to `/settings`, redirect to `/`

---

## Task 12: Frontend — API Types

**File:** `frontend/src/lib/api.ts`

- Rename settings interfaces to `GlobalSettings` / `GlobalSettingsUpdate`

---

## Task 13: Cleanup

- Remove `OPENAI_API_KEY` from `backend/.env.example`
- Remove `LLM_*` and `EMBEDDING_*` env vars from `.env.example`
- Remove the old migration file `supabase/migrations/20260123000004_user_settings.sql` (superseded)
- Update `backend/requirements.txt` if any deps changed

---

## Task 14: Validation Suite Update

**File:** `.agent/validation/full-suite.md`

Add tests:
- API: `GET /auth/me` returns `is_admin` field
- API: `PUT /settings` as non-admin → 403
- API: `PUT /settings` as admin → 200
- API: `GET /settings` as non-admin → 200 (can read)
- E2E: Non-admin user doesn't see Settings option in UserMenu
- E2E: Non-admin navigating directly to `/settings` is redirected
- E2E: Admin user can access `/settings` via UserMenu and save settings (success message shown)

---

## Verification

1. Run `supabase db push` — migration applies cleanly
2. Start backend: `powershell -File scripts/start-backend.ps1`
3. `curl http://localhost:8000/health` → `{"status":"ok"}`
4. Sign in as test@test.com (admin) via browser — Settings option visible in UserMenu
5. Navigate to `/settings`, configure LLM API key/model/base_url → saves successfully, success message shown, stays on page
6. Send a chat message → LLM responds using global settings
7. Sign in as test2@test.com (non-admin) — Settings option NOT in UserMenu, direct `/settings` URL redirects
8. test2@test.com can still chat (reads global settings for LLM config)
9. `curl -X PUT /settings` with test2 token → 403
